# ============================================
# éšæ®µ 1: Base - é‹è¡Œç’°å¢ƒ
# ============================================
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
WORKDIR /app
EXPOSE 8080

# ============================================
# éšæ®µ 2: Build - ç·¨è­¯å°ˆæ¡ˆ
# ============================================
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
ARG BUILD_CONFIGURATION=Release
WORKDIR /src

# ğŸ”§ è¤‡è£½ .csproj ä¸¦é‚„åŸå¥—ä»¶
# Dockerfile å’Œ .csproj åœ¨åŒä¸€å€‹è³‡æ–™å¤¾,æ‰€ä»¥ç›´æ¥è¤‡è£½
COPY ["VocabularyApi.csproj", "VocabularyApi/"]
RUN dotnet restore "VocabularyApi/VocabularyApi.csproj"

# ğŸ”§ è¤‡è£½æ‰€æœ‰å°ˆæ¡ˆæª”æ¡ˆ
COPY . VocabularyApi/

# åˆ‡æ›åˆ°å°ˆæ¡ˆç›®éŒ„ä¸¦ç·¨è­¯
WORKDIR "/src/VocabularyApi"
RUN dotnet build "VocabularyApi.csproj" -c $BUILD_CONFIGURATION -o /app/build

# ============================================
# éšæ®µ 3: Publish - ç™¼å¸ƒå°ˆæ¡ˆ
# ============================================
FROM build AS publish
ARG BUILD_CONFIGURATION=Release
RUN dotnet publish "VocabularyApi.csproj" -c $BUILD_CONFIGURATION -o /app/publish /p:UseAppHost=false

# ============================================
# éšæ®µ 4: Final - æœ€çµ‚æ˜ åƒ (é€™æ˜¯å¯¦éš›é‹è¡Œçš„å®¹å™¨)
# ============================================
FROM base AS final
WORKDIR /app

# å¾ publish éšæ®µè¤‡è£½ç·¨è­¯å¥½çš„æª”æ¡ˆ
COPY --from=publish /app/publish .

# ğŸ”§ Railway æœƒæä¾› PORT ç’°å¢ƒè®Šæ•¸,è¨­å®š ASP.NET Core ç›£è½é€™å€‹ç«¯å£
ENV ASPNETCORE_URLS=http://+:${PORT}

# å®¹å™¨å•Ÿå‹•æ™‚åŸ·è¡Œçš„å‘½ä»¤
ENTRYPOINT ["dotnet", "VocabularyApi.dll"]
